/** ************************************************************************************************
 *  \file       Hardware.c
 *
 *  \brief      Hardware independent part of rtos TBD
 *
 *  \date       2015-08-03
 *  \revision   $Revision: 1.5 $
 *  \author     Rommel García Hernández
 *  \copyright  Guenda Tecnología de México 2015
 *
 *  Implements the hardware independent part of the rtos TBD
 */

#include <msp430.h>
#include "Hardware.h"

/** **********************************************************************************************
 *  \brief  TBD
 *
 *
 *  \range      see enumeration FS_Ecc_t_TestResults
 *  \resolution 1
 *  \unit       None
 */
static unsigned long long int hardware_tick;
static unsigned int leap_cnt;

/**********************************************************************************************************************
 *  HardwareInitIO()
 *********************************************************************************************************************/
void HardwareInitIO() {

}

/**********************************************************************************************************************
 *  HardwareToggleP47()
 *********************************************************************************************************************/
void HardwareToggleP47() {
    P4OUT ^= BIT7;           /* Toggle P4.7 */
}

/**********************************************************************************************************************
 *  HardwareInitTimerA2()
 *********************************************************************************************************************/
void HardwareInitTimerA2() {
    TA2CTL   = TASSEL_1 | ID_0 | MC_1; // ACLK, Divider 1, Up mode
    TA2CCR0  = 32;
    TA2CCTL0 = CCIE; // Enable timer interrupts
    __bis_SR_register(GIE);
}

/**********************************************************************************************************************
 *  HardwareInitTimerA2()
 *********************************************************************************************************************/
unsigned long long int HardwareGetTick() {
    return hardware_tick;
}

/**********************************************************************************************************************
 *  Timer_A2()
 *********************************************************************************************************************/
 /*! \brief        Timer A2 interrupt service routine
 *********************************************************************************************************************/
#pragma vector=TIMER2_A0_VECTOR
__interrupt void Timer_A2(void) {
    if(leap_cnt < NUM_OF_INTERRUPTS_ERROR) {
        hardware_tick++;
        leap_cnt++;
    } else {
        /* Add an extra count to catch up */
        hardware_tick += 2;
        leap_cnt = 0;
    }
}

/**********************************************************************************************************************
 *  start_output_pin()
 *********************************************************************************************************************/
void start_output_pin(pin_t pin) {
    *(pin.pin_dir) |= pin.pin_bit; /* sets the bit as output */
    *(pin.pin_out) &= ~pin.pin_bit; /* starts to 0 */
}

/**********************************************************************************************************************
 *  rising_edge_pin()
 *********************************************************************************************************************/
void rising_edge_pin(pin_t pin) {
    *(pin.pin_out) |= pin.pin_bit;
}

/**********************************************************************************************************************
 *  falling_edge_pin()
 *********************************************************************************************************************/
void falling_edge_pin(pin_t pin) {
    *(pin.pin_out) &= ~pin.pin_bit;
}

/**********************************************************************************************************************
 *  low_pulse_pin()
 *********************************************************************************************************************/
void low_pulse_pin(pin_t pin) {
    *(pin.pin_out) &= ~pin.pin_bit;
    __delay_cycles(10);
    *(pin.pin_out) |= pin.pin_bit;
}
